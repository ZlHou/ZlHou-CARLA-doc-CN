<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Traffic Manager - CARLA 模拟器 中文文档</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Traffic Manager";
        var mkdocs_page_input_path = "adv_traffic_manager.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> CARLA 模拟器 中文文档
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">主页</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">入门</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../start_introduction/">介绍</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../start_quickstart/">快速启动包安装</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">构建CARLA</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../build_linux/">Linux build</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build_windows/">Windows build</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build_update/">Update CARLA</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build_system/">Build system</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build_docker/">CARLA in Docker</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build_faq/">F.A.Q.</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第一步</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../core_concepts/">核心概念</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../core_world/">第一、 世界和客户端</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../core_actors/">第二、 角色和蓝图</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../core_map/">第三、地图和导航 </a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../core_sensors/">第四、 传感器和数据</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">高级概念</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_opendrive/">OpenDRIVE 独立模式</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_ptv/">PTV-Vissim 联合仿真</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_recorder/">Recorder</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_rendering_options/">渲染选项</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_rss/">RSS</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_synchrony_timestep/">同步和时间步长</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_benchmarking/">基准性能</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_agents/">CARLA 代理</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">交通模拟</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../ts_traffic_simulation_overview/">交通模拟概述</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Traffic Manager</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#what-is-the-traffic-manager">What is the Traffic Manager?</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#structured-design">Structured design</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#user-customization">User customization</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#architecture">Architecture</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#alsm">ALSM</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vehicle-registry">Vehicle registry</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#simulation-state">Simulation state</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#control-loop">Control loop</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#in-memory-map">In-Memory Map</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#pbvt">PBVT</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#pid-controller">PID controller</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#command-array">Command Array</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#stages-of-the-control-loop">Stages of the Control Loop</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#stage-1-localization-stage">Stage 1- Localization Stage</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#stage-2-collision-stage">Stage 2- Collision Stage</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#stage-3-traffic-light-stage">Stage 3- Traffic Light Stage</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#stage-4-motion-planner-stage">Stage 4- Motion Planner Stage</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#stage-5-vehicle-lights-stage">Stage 5- Vehicle Lights Stage</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#using-the-traffic-manager">Using the Traffic Manager</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#vehicle-behavior-considerations">Vehicle behavior considerations</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#creating-a-traffic-manager">Creating a Traffic Manager</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#configuring-autopilot-behavior">Configuring autopilot behavior</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#delegating-the-traffic-manager-to-automatically-update-vehicle-lights">Delegating the Traffic Manager to automatically update vehicle lights</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#stopping-a-traffic-manager">Stopping a Traffic Manager</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#deterministic-mode">Deterministic mode</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#hybrid-physics-mode">Hybrid physics mode</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#running-multiple-traffic-managers">Running multiple Traffic Managers</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#traffic-manager-servers-and-clients">Traffic Manager servers and clients</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#tm-server">TM-Server</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#tm-client">TM-Client</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#multi-client-simulations">Multi-client simulations</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#multi-tm-simulations">Multi-TM simulations</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#multi-simulation">Multi-simulation</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#synchronous-mode">Synchronous mode</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#traffic-manager-in-large-maps">Traffic manager in large maps</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../adv_sumo/">SUMO 联合仿真</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_G_scenic/">Scenic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">参考</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../python_api/">Python API 参考</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../bp_library/">Blueprint Library</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ref_cpp/">C++ 参考</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ref_recorder_binary_file_format/">Recorder 二进制文件格式</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ref_sensors/">Sensors reference</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">插件</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../plugins_carlaviz/">carlaviz — web 可视化器</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ROS 桥接器</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../ros_documentation/">ROS 桥文档</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">自定义地图</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_M_custom_map_overview/">CARLA 中自定义地图的概述</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_M_generate_map/">在 RoadRunner 中创建地图</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_M_add_map_package/">在CARLA包导入地图</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_M_add_map_source/">在 CARLA 源构建中导入地图</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_M_add_map_alternative/">导入地图的替代方法</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_M_manual_map_package/">手动准备地图包</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_M_custom_layers/">自定义地图：分层地图: Layered maps</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_M_custom_add_tl/">自定义地图：红绿灯和标志</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_M_custom_road_painter/">自定义地图：Road painter</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_M_custom_buildings/">自定义地图：程序建筑</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_M_custom_weather_landscape/">自定义地图：天气和景观</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_M_generate_pedestrian_navigation/">生成行人导航</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">大型地图</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../large_map_overview/">大型地图概述</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../large_map_roadrunner/">在RoadRunner中创建大地图</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../large_map_import/">导入/打包大地图</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">教程（通用）</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_G_add_friction_triggers/">添加摩擦触发器</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_G_control_vehicle_physics/">控制车辆物理模型</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_G_control_walker_skeletons/">控制行人骨骼</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_G_openstreetmap/">使用OpenStreetMap生成地图</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_G_retrieve_data/">检索模拟数据</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_G_carsim_integration/">CarSim 集成</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_G_rllib_integration/">RLlib 集成</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_G_chrono/">Chrono 集成</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build_docker_unreal/">在 Docker 中构建虚幻引擎UE和 CARLA</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">教程（资产）</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_A_add_vehicle/">添加新车辆</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_A_add_props/">添加新道具</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_A_create_standalone/">创建独立包</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_A_material_customization/">材料定制</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">教程（开发人员）</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_D_contribute_assets/">如何升级内容</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_D_create_sensor/">创建一个传感器</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_D_create_semantic_tags/">创建语义标签</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_D_customize_vehicle_suspension/">自定义车辆悬架</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_D_generate_colliders/">生成详细碰撞</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuto_D_make_release/">发布版本</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">CARLA 生态系统</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../ecosys_ansys/">Ansys 实时雷达模型</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">贡献</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../cont_contribution_guidelines/">贡献指南</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cont_code_of_conduct/">行为准则</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cont_coding_standard/">编码标准</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cont_doc_standard/">文档标准</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">CARLA 模拟器 中文文档</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>交通模拟 &raquo;</li><li>Traffic Manager</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="traffic-manager">Traffic Manager</h1>
<ul>
<li><a href="#what-is-the-traffic-manager"><strong>What is the Traffic Manager?</strong></a><ul>
<li><a href="#structured-design">Structured design</a></li>
<li><a href="#user-customization">User customization</a></li>
</ul>
</li>
<li><a href="#architecture"><strong>Architecture</strong></a><ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#alsm">ALSM</a></li>
<li><a href="#vehicle-registry">Vehicle registry</a></li>
<li><a href="#simulation-state">Simulation state</a></li>
<li><a href="#control-loop">Control loop</a></li>
<li><a href="#in-memory-map">In-Memory Map</a></li>
<li><a href="#pbvt">PBVT</a></li>
<li><a href="#pid-controller">PID controller</a></li>
<li><a href="#command-array">Command array</a></li>
<li><a href="#stages-of-the-control-loop">Stages of the Control Loop</a></li>
</ul>
</li>
<li><a href="#using-the-traffic-manager"><strong>Using the Traffic Manager</strong></a><ul>
<li><a href="#vehicle-behavior-considerations">Vehicle behavior considerations</a></li>
<li><a href="#creating-a-traffic-manager">Creating a Traffic Manager</a></li>
<li><a href="#configuring-autopilot-behavior">Configuring autopilot behavior</a></li>
<li><a href="#stopping-a-traffic-manager">Stopping a Traffic Manager</a></li>
</ul>
</li>
<li><a href="#deterministic-mode"><strong>Deterministic mode</strong></a></li>
<li><a href="#hybrid-physics-mode"><strong>Hybrid physics mode</strong></a></li>
<li><a href="#running-multiple-traffic-managers"><strong>Running multiple Traffic Managers</strong></a><ul>
<li><a href="#traffic-manager-servers-and-clients">Traffic Manager servers and clients</a></li>
<li><a href="#multi-client-simulations">Multi-client simulations</a></li>
<li><a href="#multi-tm-simulations">Multi-TM simulations</a></li>
<li><a href="#multi-simulation">Multi-simulation</a></li>
</ul>
</li>
<li><a href="#synchronous-mode"><strong>Synchronous mode</strong></a></li>
<li><a href="#traffic-manager-in-large-maps"><strong>Traffic manager in large maps</strong></a></li>
</ul>
<hr />
<h2 id="what-is-the-traffic-manager">What is the Traffic Manager?</h2>
<p>The Traffic Manager (TM) is the module that controls vehicles in autopilot mode in a simulation. Its goal is to populate a simulation with realistic urban traffic conditions. Users can customize some behaviors, for example, to set specific learning circumstances.</p>
<h3 id="structured-design">Structured design</h3>
<p>TM is built on CARLA's client-side. The execution flow is divided into <strong>stages</strong>, each with independent operations and goals. This facilitates the development of phase-related functionalities and data structures while improving computational efficiency. Each stage runs on a different thread. Communication with other stages is managed through synchronous messaging. Information flows in one direction.</p>
<h3 id="user-customization">User customization</h3>
<p>Users have some control over the traffic flow by setting parameters that allow, force, or encourage specific behaviors. Users can change the traffic behavior as they prefer, both online and offline. For example, cars can be allowed to ignore the speed limits or force a lane change. Being able to play around with behaviors is indispensable when trying to simulate reality. Driving systems need to be trained under specific and atypical circumstances.</p>
<hr />
<h2 id="architecture">Architecture</h2>
<h3 id="overview">Overview</h3>
<p><img alt="Architecture" src="../img/tm_2_architecture.jpg" /></p>
<p>The above diagram is a representation of the internal architecture of the TM. The C++ code for each component can be found in <code>LibCarla/source/carla/trafficmanager</code>. Each component is explained in detail in the following sections. A simplified overview of the logic is as follows: </p>
<p><strong>1. Store and update the current state of the simulation.</strong></p>
<ul>
<li>The <a href="#alsm">Agent Lifecycle &amp; State Management</a> (ALSM) scans the world to keep track of all the vehicles and walkers present and to clean up entries for those that no longer exist. All the data is retrieved from the server and is passed through several <a href="#stages-of-the-control-loop">stages</a>. The ALSM is the only component that makes calls to the server.</li>
<li>The <a href="#vehicle-registry">vehicle registry</a> contains an array of vehicles on autopilot (controlled by the TM) and a list of pedestrians and vehicles not on autopilot (not controlled by the TM).</li>
<li>The <a href="#simulation-state">simulation state</a> is a cache store of the position, velocity, and additional information of all the vehicles and pedestrians in the simulation.</li>
</ul>
<p><strong>2. Calculate the movement of every autopilot vehicle.</strong></p>
<p>The TM generates viable commands for all vehicles in the <a href="#vehicle-registry">vehicle registry</a> according to the <a href="#simulation-state">simulation state</a>. Calculations for each vehicle are done separately. These calculations are divided into different <a href="#stages-of-the-control-loop">stages</a>. The <a href="#control-loop">control loop</a> makes sure that all calculations are consistent by creating <strong>synchronization barriers</strong> between stages. No vehicle moves to the next stage before calculations are finished for all vehicles in the current stage. Each vehicle goes through the following stages:</p>
<blockquote>
<p><strong>2.1 - <a href="#stage-1-localization-stage">Localization Stage</a>.</strong></p>
<p>Paths are created dynamically using a list of nearby waypoints collected from the <a href="#in-memory-map">In-Memory Map</a>, a simplification of the simulation map as a grid of waypoints. Directions at junctions are chosen randomly. Each vehicle's path is stored and maintained by the <a href="#pbvt">Path Buffers &amp; Vehicle Tracking</a> (PBVT) component for easy access and modification in future stages.</p>
<p><strong>2.2 - <a href="#stage-2-collision-stage">Collision Stage</a>.</strong></p>
<p>Bounding boxes are extended over each vehicle's path to identify and navigate potential collision hazards.</p>
<p><strong>2.3 - <a href="#stage-3-traffic-light-stage">Traffic Light Stage</a>.</strong></p>
<p>Similar to the Collision Stage, potential hazards that affect each vehicle's path due to traffic light influence, stop signs, and junction priority are identified.</p>
<p><strong>2.4 - <a href="#stage-4-motion-planner-stage">Motion Planner Stage</a>.</strong></p>
<p>Vehicle movement is computed based on the defined path. A <a href="#pid-controller">PID controller</a> determines how to reach the target waypoints. This is then translated into a CARLA command for application in the next step.</p>
<p><strong>2.5 - <a href="#stage-5-vehicle-lights-stage">Vehicle Lights Stage</a>.</strong></p>
<p>The vehicle lights switch on/off dynamically based on environmental factors (e.g. sunlight and the presence of fog or rain) and vehicle behavior (e.g. turning on direction indicators if the vehicle will turn left/right at the next junction, or turn on the stop lights if braking).</p>
</blockquote>
<p><strong>3. Apply the commands in the simulation.</strong></p>
<p>Commands generated in the previous step are collected into the <a href="#command-array">command array</a> and sent to the CARLA server in a batch to be applied in the same frame.</p>
<p>The following sections will explain each component and stage in the TM logic described above in more detail.</p>
<h3 id="alsm">ALSM</h3>
<p>ALSM stands for <strong>Agent Lifecycle and State Management</strong>. It is the first step in the TM logic cycle and provides context of the simulation's current state.</p>
<p>The ALSM component:</p>
<ul>
<li>Scans the world to keep track of all vehicles and pedestrians, their positions and velocities. If physics are enabled, the velocity is retrieved by <a href="../python_api/#carla.Vehicle">Vehicle.get_velocity()</a>. Otherwise, the velocity is calculated using the history of position updates over time.</li>
<li>Stores the position, velocity, and additional information (traffic light influence, bounding boxes, etc) of every vehicle and pedestrian in the <a href="#simulation-state">simulation state</a> component.</li>
<li>Updates the list of TM-controlled vehicles in the <a href="#vehicle-registry">vehicle registry</a>.</li>
<li>Updates entries in the <a href="#control-loop">control loop</a> and <a href="#pbvt">PBVT</a> components to match the vehicle registry.</li>
</ul>
<p><strong>Related .cpp files:</strong> <code>ALSM.h</code>, <code>ALSM.cpp</code>.</p>
<h3 id="vehicle-registry">Vehicle registry</h3>
<p>The vehicle registry keeps track of all vehicles and pedestrians in the simulation.</p>
<p>The vehicle registry:</p>
<ul>
<li>Is passed an updated list of vehicles and pedestrians from the <a href="#alsm">ALSM</a>.</li>
<li>Stores vehicles registered to the TM in a separate array for iteration during the <a href="#control-loop">control loop</a>.</li>
</ul>
<p><strong>Related .cpp files:</strong> <code>MotionPlannerStage.cpp</code>.</p>
<h3 id="simulation-state">Simulation state</h3>
<p>The simulation state stores information about all vehicles in the simulation for easy access and modification in later stages.</p>
<p>The simulation state:</p>
<ul>
<li>Receives data from the <a href="#alsm">ALSM</a> including current actor position, velocity, traffic light influence, traffic light state, etc.</li>
<li>Stores all information in cache, avoiding subsequent calls to the server during the <a href="#control-loop">control loop</a>.</li>
</ul>
<p><strong>Related .cpp files:</strong> <code>SimulationState.cpp</code>, <code>SimulationState.h</code>.</p>
<h3 id="control-loop">Control loop</h3>
<p>The control loop manages the calculations of the next command for all autopilot vehicles so they are performed synchronously. The control loop consists of five different <a href="#stages-of-the-control-loop">stages</a>; localization, collision, traffic light, motion planner and vehicle lights.</p>
<p>The control loop:</p>
<ul>
<li>Receives an array of TM-controlled vehicles from the <a href="#vehicle-registry">vehicle registry</a>.</li>
<li>Performs calculations for each vehicle separately by looping over the array.</li>
<li>Divides calculations into a series of <a href="#stages-of-the-control-loop">stages</a>.</li>
<li>Creates synchronization barriers between stages to guarantee consistency. Calculations for all vehicles are finished before any of them move to the next stage, ensuring all vehicles are updated in the same frame.</li>
<li>Coordinates the transition between <a href="#stages-of-the-control-loop">stages</a> so all calculations are done in sync.</li>
<li>Sends the <a href="#command-array">command array</a> to the server when the last stages (<a href="#stage-4-motion-planner-stage">Motion Planner Stage</a> and <a href="#stage-5-vehicle-lights-stage">Vehicle Lights Stage</a>) finishes so there are no frame delays between the command calculations and the command application.</li>
</ul>
<p><strong>Related .cpp files:</strong> <code>TrafficManagerLocal.cpp</code>.</p>
<h3 id="in-memory-map">In-Memory Map</h3>
<p>The In-Memory Map is a helper module contained within the <a href="#pbvt">PBVT</a> and is used during the <a href="#stage-1-localization-stage">Localization Stage</a>.  </p>
<p>The In-Memory Map:</p>
<ul>
<li>Converts the map into a grid of discrete waypoints.</li>
<li>Includes waypoints in a specific data structure with more information to connect waypoints and identify roads, junctions, etc.</li>
<li>Identifies these structures with an ID used to locate vehicles in nearby areas quickly.</li>
</ul>
<p><strong>Related .cpp files:</strong> <code>InMemoryMap.cpp</code> and <code>SimpleWaypoint.cpp</code>.</p>
<h3 id="pbvt">PBVT</h3>
<p>PBVT stands for <strong>Path Buffer and Vehicle Tracking</strong>. The PBVT is a data structure that contains the expected path for every vehicle and allows easy access to data during the <a href="#control-loop">control loop</a>.</p>
<p>The PBVT:</p>
<ul>
<li>Contains a map of deque objects with one entry per vehicle.</li>
<li>Contains a set of waypoints for each vehicle describing its current location and near-future path.</li>
<li>Contains the <a href="#in-memory-map">In-Memory Map</a> used by the <a href="#stage-1-localization-stage">Localization Stage</a> to relate every vehicle to the nearest waypoint and possible overlapping paths.</li>
</ul>
<h3 id="pid-controller">PID controller</h3>
<p>The PID controller is a helper module that performs calculations during the <a href="#stage-4-motion-planner-stage">Motion Planner Stage</a>.</p>
<p>The PID controller:</p>
<ul>
<li>Estimates the throttle, brake, and steering input needed to reach a target value using the information gathered by the <a href="#stage-4-motion-planner-stage">Motion Planner Stage</a>.</li>
<li>Makes adjustments depending on the specific parameterization of the controller. Parameters can be modified if desired. Read more about <a href="https://en.wikipedia.org/wiki/PID_controller">PID controllers</a> to learn how to make modifications.</li>
</ul>
<p><strong>Related .cpp files:</strong> <code>PIDController.cpp</code>.</p>
<h3 id="command-array">Command Array</h3>
<p>The Command Array represents the last step in the TM logic cycle. It receives commands for all the registered vehicles and applies them.</p>
<p>The Command Array:</p>
<ul>
<li>Receives a series of <a href="../python_api/#carla.VehicleControl">carla.VehicleControl</a>'s from the <a href="#stage-4-motion-planner-stage">Motion Planner Stage</a>.</li>
<li>Batches all commands to be applied during the same frame.</li>
<li>Sends the batch to the CARLA server calling either <strong>apply_batch()</strong> or <strong>apply_batch_synch()</strong> in <a href="../python_api/#carla.Client">carla.Client</a> depending on whether the simulation is running in asynchronous or synchronous mode, respectively.</li>
</ul>
<p><strong>Related .cpp files:</strong> <code>TrafficManagerLocal.cpp</code>.</p>
<h3 id="stages-of-the-control-loop">Stages of the Control Loop</h3>
<h5 id="stage-1-localization-stage">Stage 1- Localization Stage</h5>
<p>The Localization Stage defines a near-future path for vehicles controlled by the TM.</p>
<p>The Localization Stage:</p>
<ul>
<li>Obtains the position and velocity of all vehicles from the <a href="#simulation-state">simulation state</a>.</li>
<li>Uses the <a href="#in-memory-map">In-Memory Map</a> to relate every vehicle with a list of waypoints that describes its current location and near-future path according to its trajectory. The faster the vehicle goes, the longer the list will be.</li>
<li>Updates the path according to planning decisions such as lane changes, speed limit, distance to leading vehicle parameterization, etc.</li>
<li>Stores the path for all vehicles in the <a href="#pbvt">PBVT</a> module.</li>
<li>Compares paths with each other to estimate possible collision situations. Results are passed to the Collision Stage.</li>
</ul>
<p><strong>Related .cpp files:</strong> <code>LocalizationStage.cpp</code> and <code>LocalizationUtils.cpp</code>.</p>
<h5 id="stage-2-collision-stage">Stage 2- Collision Stage</h5>
<p>The Collision Stage triggers collision hazards.</p>
<p>The Collision Stage:</p>
<ul>
<li>Receives from the <a href="#stage-1-localization-stage">Localization Stage</a> a list of vehicle pairs whose paths could potentially overlap.</li>
<li>Extends bounding boxes along the path ahead (geodesic boundaries) for each vehicle pair to check if they actually overlap and determine whether the risk of collision is real.</li>
<li>Sends hazards for all possible collisions to the <a href="#stage-4-motion-planner-stage">Motion Planner Stage</a> to modify the path accordingly.</li>
</ul>
<p><strong>Related .cpp files:</strong> <code>CollisionStage.cpp</code>.</p>
<h5 id="stage-3-traffic-light-stage">Stage 3- Traffic Light Stage</h5>
<p>The Traffic Light stage triggers hazards due to traffic regulators such as traffic lights, stop signs, and priority at junctions.</p>
<p>The Traffic Light stage:</p>
<ul>
<li>Sets a traffic hazard if a vehicle is under the influence of a yellow or red traffic light or a stop sign.</li>
<li>Extends a bounding box along a vehicle's path if it is in an unsignaled junction. Vehicles with overlapping paths follow a "First-In-First-Out" order to move. Wait times are set to a fixed value.</li>
</ul>
<p><strong>Related .cpp files:</strong> <code>TrafficLightStage.cpp</code>.</p>
<h5 id="stage-4-motion-planner-stage">Stage 4- Motion Planner Stage</h5>
<p>The Motion Planner Stage generates the CARLA commands to be applied to vehicles.</p>
<p>The Motion Planner Stage:</p>
<ul>
<li>Gathers a vehicle's position and velocity (<a href="#simulation-state">simulation state</a>), path (<a href="#pbvt">PBVT</a>), and hazards (<a href="#stage-2-collision-stage">Collision Stage</a> and <a href="#stage-3-traffic-light-stage">Traffic Light Stage</a>).</li>
<li>Makes high-level decisions about how a vehicle should move, for example, computing the brake needed to prevent a collision hazard. A <a href="#pid-controller">PID controller</a> is used to estimate behaviors according to target values.</li>
<li>Translates the desired movement to a <a href="../python_api/#carla.VehicleControl">carla.VehicleControl</a> for application to the vehicle.</li>
<li>Sends the resulting CARLA commands to the <a href="#command-array">Command Array</a>.</li>
</ul>
<p><strong>Related .cpp files:</strong> <code>MotionPlannerStage.cpp</code>.</p>
<h5 id="stage-5-vehicle-lights-stage">Stage 5- Vehicle Lights Stage</h5>
<p>The Vehicle Lights Stage activates the lights based on the condition of the vehicle and the surrounding environment.</p>
<p>The Vehicle Lights Stage:</p>
<ul>
<li>
<p>Retrieves the planned waypoints for the vehicle, information about vehicle lights (eg. light state and the planned command to be applied) and the weather conditions.</p>
</li>
<li>
<p>Determines the new state of the vehicle lights:</p>
<ul>
<li>Turns on the blinkers if the vehicle is planning to turn left/right at the next junction.</li>
<li>Turns on the stop lights if the applied command is asking the vehicle to brake.</li>
<li>Turns on the low beams and the position lights from sunset to dawn, or under heavy rain.</li>
<li>Turns on the fog lights under heavy fog conditions.</li>
</ul>
</li>
<li>
<p>Update the vehicle lights state if it has changed.</p>
</li>
</ul>
<p><strong>Related .cpp files:</strong> <code>VehicleLightStage.cpp</code>.</p>
<hr />
<h2 id="using-the-traffic-manager">Using the Traffic Manager</h2>
<h3 id="vehicle-behavior-considerations">Vehicle behavior considerations</h3>
<p>The TM implements general behavior patterns that must be taken into consideration when you set vehicles to autopilot:</p>
<ul>
<li><strong>Vehicles are not goal-oriented,</strong> they follow a dynamically produced trajectory and choose a path randomly when approaching a junction. Their path is endless.</li>
<li><strong>Vehicles' target speed is 70% of their current speed limit</strong> unless any other value is set.</li>
<li><strong>Junction priority does not follow traffic regulations.</strong> The TM uses its own priority system at junctions. The resolution of this restriction is a work in progress. In the meantime, some issues may arise, for example, vehicles inside a roundabout yielding to a vehicle trying to get in.</li>
</ul>
<p>TM behavior can be adjusted through the Python API. For specific methods, see the TM section of the Python API <a href="../python_api/#carla.TrafficManager">documentation</a>. Below is a general summary of what is possible through the API:</p>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>General:</strong></td>
<td>- Create a TM instance connected to a port. <br> - Retrieve the port where a TM is connected.</td>
</tr>
<tr>
<td><strong>Safety conditions:</strong></td>
<td>- Set a minimum distance between stopped vehicles (for a single vehicle or for all vehicles). This will affect the minimum moving distance. <br> - Set the desired speed as a percentage of the current speed limit (for a single vehicle or for all vehicles). <br> - Reset traffic lights.</td>
</tr>
<tr>
<td><strong>Collision  managing:</strong></td>
<td>- Enable/Disable collisions between a vehicle and a specific actor. <br> - Make a vehicle ignore all other vehicles. <br> - Make a vehicle ignore all walkers. <br> - Make a vehicle ignore all traffic lights.</td>
</tr>
<tr>
<td><strong>Lane  changes:</strong></td>
<td>- Force a lane change, ignoring possible collisions. <br> - Enable/Disable lane changes for a vehicle.</td>
</tr>
<tr>
<td><strong>Hybrid physics mode:</strong></td>
<td>- Enable/Disable hybrid physics mode. <br> - Change the radius in which physics is enabled.</td>
</tr>
</tbody>
</table>
<h3 id="creating-a-traffic-manager">Creating a Traffic Manager</h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>TM is designed to work in synchronous mode. Using TM in asynchronous mode can lead to unexpected and undesirable results. Read more in the section <a href="#synchronous-mode"><strong>Synchronous mode</strong></a>.</p>
</div>
<p>A TM instance is created by a <a href="../python_api/#carla.Client"><code>carla.Client</code></a>, passing the port to be used. The default port is <code>8000</code>.</p>
<p>To create a TM instance:</p>
<pre><code class="language-python">tm = client.get_trafficmanager(port)
</code></pre>
<p>To enable autopilot for a set of vehicles, retrieve the port of the TM instance and set <code>set_autopilot</code> to <code>True</code>, passing the TM port at the same time. If no port is provided, it will try to connect to a TM in the default port (<code>8000</code>). If the TM does not exist, it will create one:</p>
<pre><code class="language-python">tm_port = tm.get_port()
 for v in vehicles_list:
     v.set_autopilot(True,tm_port)
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Creating or connecting to a TM in multi-client situations is different from the above example. Learn more in the section <a href="#running-multiple-traffic-managers"><strong>Running multiple Traffic Managers</strong></a>.</p>
</div>
<p>The <code>generate_traffic.py</code> script in <code>/PythonAPI/examples</code> provides an example of how to create a TM instance using a port passed as a script argument and register every vehicle spawned to it by setting the autopilot to <code>True</code> in a batch:</p>
<pre><code class="language-py">traffic_manager = client.get_trafficmanager(args.tm-port)
tm_port = traffic_manager.get_port()
...
batch.append(SpawnActor(blueprint, transform).then(SetAutopilot(FutureActor, True,tm_port)))
...
traffic_manager.global_percentage_speed_difference(30.0)
</code></pre>
<h3 id="configuring-autopilot-behavior">Configuring autopilot behavior</h3>
<p>The following example creates a TM instance and configures dangerous behavior for a specific vehicle so it will ignore all traffic lights, leave no safety distance from other vehicles, and drive 20% faster than the current speed limit:</p>
<pre><code class="language-python">tm = client.get_trafficmanager(port)
tm_port = tm.get_port()
for v in my_vehicles:
  v.set_autopilot(True,tm_port)
danger_car = my_vehicles[0]
tm.ignore_lights_percentage(danger_car,100)
tm.distance_to_leading_vehicle(danger_car,0)
tm.vehicle_percentage_speed_difference(danger_car,-20)
</code></pre>
<p>The example below sets the same list of vehicles to autopilot but instead configures them with moderate driving behavior. The vehicles drive 80% slower than the current speed limit, leaving at least 5 meters between themselves and other vehicles, and never perform lane changes:</p>
<pre><code class="language-python">tm = client.get_trafficmanager(port)
tm_port = tm.get_port()
for v in my_vehicles:
  v.set_autopilot(True,tm_port)
danger_car = my_vehicles[0]
tm.global_distance_to_leading_vehicle(5)
tm.global_percentage_speed_difference(80)
for v in my_vehicles: 
  tm.auto_lane_change(v,False)
</code></pre>
<h4 id="delegating-the-traffic-manager-to-automatically-update-vehicle-lights">Delegating the Traffic Manager to automatically update vehicle lights</h4>
<p>By default, vehicle lights (brake, turn indicators, etc...) of the vehicles managed by the TM are never updated. It is possible to delegate the TM to update the vehicle lights of a given vehicle actor:</p>
<pre><code class="language-python">tm = client.get_trafficmanager(port)
for actor in my_vehicles:
  tm.update_vehicle_lights(actor, True)
</code></pre>
<p>Vehicle lights management has to be specified on a per-vehicle basis, and there could be at any given time both vehicles with and without the automatic light management.</p>
<h3 id="stopping-a-traffic-manager">Stopping a Traffic Manager</h3>
<p>The TM is not an actor that needs to be destroyed; it will stop when the client that created it stops. This is automatically managed by the API, the user does not have to do anything. However, when shutting down a TM, the user must destroy the vehicles controlled by it, otherwise they will remain immobile on the map. The script <code>generate_traffic.py</code> does this automatically:</p>
<pre><code class="language-py">client.apply_batch([carla.command.DestroyActor(x) for x in vehicles_list])
</code></pre>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Shutting down a <strong>TM-Server</strong> will shut down the <strong>TM-Clients</strong> connecting to it. To learn the difference between a <strong>TM-Server</strong> and a <strong>TM-Client</strong>, read about <a href="#running-multiple-traffic-managers"><strong>Running multiple Traffic Managers</strong></a>.</p>
</div>
<hr />
<h2 id="deterministic-mode">Deterministic mode</h2>
<p>In deterministic mode, the TM will produce the same results and behaviors under the same conditions. Do not mistake determinism with the recorder. While the recorder allows you to store the log of a simulation to play it back, determinism ensures that the TM will always have the same output over different executions of a script as long as the same conditions are maintained.</p>
<p>Deterministic mode is available <strong>in synchronous mode only</strong>. In asynchronous mode, there is less control over the simulation and determinism cannot be achieved. Read more in the section <a href="#synchronous-mode"><strong>"Synchronous mode"</strong></a> before starting.</p>
<p>To enable deterministic mode, use the following method:</p>
<pre><code class="language-py">my_tm.set_random_device_seed(seed_value)
</code></pre>
<p><code>seed_value</code> is an <code>int</code> number from which random numbers will be generated. The value itself is not relevant, but the same value will always result in the same output. Two simulations, with the same conditions, that use the same seed value, will be deterministic.</p>
<p>To maintain determinism over multiple simulation runs, <strong>the seed must be set for every simulation</strong>. For example, each time the world is <a href="../python_api/#carla.Client.reload_world">reloaded</a>, the seed must be set again:</p>
<pre><code class="language-py">client.reload_world()
my_tm.set_random_device_seed(seed_value)
</code></pre>
<p>Deterministic mode can be tested in the <code>generate_traffic.py</code> example script by passing a seed value as an argument. The following example populates a map with 50 autopilot actors in synchronous mode and sets the seed to an arbitrary value of <code>9</code>:</p>
<pre><code class="language-sh">cd PythonAPI/examples
python3 generate_traffic.py -n 50 --seed 9
</code></pre>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The CARLA server and the TM must be in synchronous mode before enabling deterministic mode. Read more <a href="#synchronous-mode">here</a> about synchronous mode in TM.</p>
</div>
<hr />
<h2 id="hybrid-physics-mode">Hybrid physics mode</h2>
<p>Hybrid mode allows users to disable most physics calculations for all autopilot vehicles, or for autopilot vehicles outside of a certain radius of a vehicle tagged with <code>hero</code>. This removes the vehicle physics bottleneck from a simulation. Vehicles whose physics are disabled will move by teleportation. Basic calculations for linear acceleration are maintained to ensure position updates and vehicle speed remain realistic and the toggling of physics calculations on vehicles is fluid.</p>
<p>Hybrid mode uses the <a href="https://carla.readthedocs.io/en/latest/python_api/#carla.Actor.set_simulate_physics"><code>Actor.set_simulate_physics()</code></a> method to toggle physics calculations. It is disabled by default. There are two options to enable it:</p>
<ul>
<li><a href="https://carla.readthedocs.io/en/latest/python_api/#carla.TrafficManager.set_hybrid_physics_mode"><strong><code>TrafficManager.set_hybrid_physics_mode(True)</code></strong></a> — This method enables hybrid mode for the TM object calling it.</li>
<li><strong>Running <code>generate_traffic.py</code> with the flag <code>--hybrid</code></strong> — This example script creates a TM and spawns vehicles in autopilot. It then sets these vehicles to hybrid mode when the <code>--hybrid</code> flag is passed as a script argument.</li>
</ul>
<p>To modify the behavior of hybrid mode, use the following two parameters:</p>
<ul>
<li><strong>Radius</strong> <em>(default = 50 meters)</em> — The radius is relative to vehicles tagged with <code>hero</code>. All vehicles inside this radius will have physics enabled; vehicles outside of the radius will have physics disabled. The size of the radius is modified using <a href="../python_api/#carla.TrafficManager.set_hybrid_physics_radius"><code>traffic_manager.set_hybrid_physics_radius(r)</code></a>.</li>
<li><strong>Hero vehicle</strong> — A vehicle tagged with <code>role_name='hero'</code> that acts as the center of the radius.<ul>
<li><strong>If there is no hero vehicle,</strong> all vehicles' physics will be disabled.</li>
<li><strong>If there is more than one hero vehicle,</strong> the radius will be considered for them all, creating different areas of influence with physics enabled.</li>
</ul>
</li>
</ul>
<p>The clip below shows how physics is enabled and disabled when hybrid mode is active. The <strong>hero vehicle</strong> is tagged with a <strong>red square</strong>. Vehicles with <strong>physics disabled</strong> are tagged with a <strong>blue square</strong>. When inside the hero vehicle's radius of influence, <strong>physics are enabled and the tag becomes green</strong>.</p>
<p><img alt="Welcome to CARLA" src="../img/tm_hybrid.gif" /></p>
<hr />
<h2 id="running-multiple-traffic-managers">Running multiple Traffic Managers</h2>
<h3 id="traffic-manager-servers-and-clients">Traffic Manager servers and clients</h3>
<p>A CARLA client creates a TM by specifying to the server which port to use. If a port is not specified, the default <code>8000</code> will be used. If further TMs are created on the same port, they will become <strong>TM-Clients</strong> and the original TM will become a <strong>TM-Server</strong>. These titles define how a TM behaves within a simulation.</p>
<h6 id="tm-server">TM-Server</h6>
<p>A TM-Server is created if it was the first TM to connect to a free port and then other TMs (TM-Clients) connected to the same port it was running on. <strong>The TM-Server will dictate the behavior of all the TM-Clients</strong>, e.g., if the TM-Server is stopped, all TM-Clients will stop.</p>
<p>The following code creates two TM-Servers. Each one connects to a different, unused port:</p>
<pre><code class="language-py">tm01 = client01.get_trafficmanager() # tm01 --&gt; tm01 (p=8000)
</code></pre>
<pre><code class="language-py">tm02 = client02.get_trafficmanager(5000) # tm02(p=5000) --&gt; tm02 (p=5000)
</code></pre>
<h6 id="tm-client">TM-Client</h6>
<p>A TM-Client is created when a TM connects to a port occupied by another TM (TM-Server). The TM-Client behavior will be dictated by the TM-Server.</p>
<p>The following code creates two TM-Clients, each one connecting with the TM-Servers created in the section above.</p>
<pre><code class="language-py">tm03 = client03.get_trafficmanager() # tm03 --&gt; tm01 (p=8000). 
</code></pre>
<pre><code class="language-py">tm04 = client04.get_trafficmanager(5000) # tm04(p=5000) --&gt; tm02 (p=5000)
</code></pre>
<p>The CARLA server keeps a register of all TM instances by storing the port and the client IP (hidden to the user) that link to them. There is currently no way to check the TM instances that have been created so far. A connection will always be attempted when trying to create an instance and it will either create a new <strong>TM-Server</strong> or a <strong>TM-Client</strong>.</p>
<h3 id="multi-client-simulations">Multi-client simulations</h3>
<p>In a multi-client simulation, multiple TMs are created on the same port. The first TM will be a TM-Server and the rest will be TM-Clients connecting to it. The TM-Server will dictate the behavior of all the TM instances:</p>
<pre><code class="language-py">terminal 1: ./CarlaUE4.sh -carla-rpc-port=4000
terminal 2: python3 generate_traffic.py --port 4000 --tm-port 4050 # TM-Server
terminal 3: python3 generate_traffic.py --port 4000 --tm-port 4050 # TM-Client
</code></pre>
<h3 id="multi-tm-simulations">Multi-TM simulations</h3>
<p>In a multi-TM simulation, multiple TM instances are created on distinct ports. Each TM instance will control its own behavior:</p>
<pre><code class="language-py">terminal 1: ./CarlaUE4.sh -carla-rpc-port=4000
terminal 2: python3 generate_traffic.py --port 4000 --tm-port 4050 # TM-Server A
terminal 3: python3 generate_traffic.py --port 4000 --tm-port 4550 # TM-Server B
</code></pre>
<h3 id="multi-simulation">Multi-simulation</h3>
<p>Multi-simulation is when more than one CARLA server is running at the same time. The TM needs to connect to the relevant CARLA server port. As long as the computational power allows for it, the TM can run multiple simulations at a time without any problems:</p>
<pre><code class="language-py">terminal 1: ./CarlaUE4.sh -carla-rpc-port=4000 # simulation A 
terminal 2: ./CarlaUE4.sh -carla-rpc-port=5000 # simulation B
terminal 3: python3 generate_traffic.py --port 4000 --tm-port 4050 # TM-Server A connected to simulation A
terminal 4: python3 generate_traffic.py --port 5000 --tm-port 5050 # TM-Server B connected to simulation B
</code></pre>
<p>The concept of multi-simulation is independent of the TM itself. The example above runs two CARLA simulations in parallel, A and B. In each of them, a TM-Server is created independently from the other. Simulation A could run a multi-client TM while simulation B is running a multi-TM or no TM at all.</p>
<p>The most likely issue arising from the above set-up is a client trying to connect to an already existing TM that is not running on the selected simulation. If this happens, an error message will appear and the connection will be aborted to prevent interferences between simulations.</p>
<hr />
<h2 id="synchronous-mode">Synchronous mode</h2>
<p>TM is designed to work in synchronous mode. Both the CARLA server and TM should be set to synchronous in order to function properly. <strong>Using TM in asynchronous mode can lead to unexpected and undesirable results,</strong> however, if asynchronous mode is required, the simulation should run at 20-30 fps at least.</p>
<p>The script below demonstrates how to set both the server and TM to synchronous mode:</p>
<pre><code class="language-py">...

# Set the simulation to sync mode
init_settings = world.get_settings()
settings = world.get_settings()
settings.synchronous_mode = True
# After that, set the TM to sync mode
my_tm.set_synchronous_mode(True)

...

# Tick the world in the same client
world.apply_settings(init_settings)
world.tick()
...

# Always disable sync mode before the script ends to prevent the server blocking whilst waiting for a tick
settings.synchronous_mode = False
my_tm.set_synchronous_mode(False)
</code></pre>
<p>The <code>generate_traffic.py</code> example script starts a TM and populates the map with vehicles and pedestrians. It automatically sets the TM and the CARLA server to synchronous mode:</p>
<pre><code class="language-sh">cd PythonAPI/examples
python3 generate_traffic.py -n 50
</code></pre>
<p>If asynchronous mode is required, use the <code>--async</code> flag when running the above command.</p>
<p>If more than one TM is set to synchronous mode, synchrony will fail. Follow these guidelines to avoid issues:</p>
<ul>
<li>In a <strong><a href="#multiclient">multiclient</a></strong> situation, only the <strong>TM-Server</strong> should be set to synchronous mode.</li>
<li>In a <strong><a href="#multitm">multiTM</a></strong> situation, only <strong>one TM-Server</strong> should be set to synchronous mode.</li>
<li>The <strong><a href="https://carla-scenariorunner.readthedocs.io/en/latest/">ScenarioRunner module</a></strong> runs a TM automatically. The TM inside ScenarioRunner will automatically be the one set to sync mode.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Disable synchronous mode (for both the world and TM) in your script managing ticks before it finishes to prevent the server blocking, waiting forever for a tick.</p>
</div>
<hr />
<h2 id="traffic-manager-in-large-maps">Traffic manager in large maps</h2>
<p>To understand how the TM works on large maps, make sure to first familiarise yourself with how large maps work by reading the documentation <a href="../large_map_overview/">here</a>.</p>
<p>The behavior of autopilot vehicles in large maps depends on whether or not there is a hero vehicle present:</p>
<p><strong>Hero vehicle not present</strong></p>
<p>All autopilot vehicles will be considered dormant actors. The dormant autopilot actors will be moved around the map as in hybrid mode. The vehicles will not be rendered since there is no hero vehicle to trigger map tile streaming.</p>
<p><strong>Hero vehicle present</strong></p>
<p>Autopilot vehicles will become dormant when they exceed the value defined by <code>actor_active_distance</code>. To set this value, use the Python API:</p>
<pre><code class="language-py">settings = world.get_settings()

# Actors will become dormant 2km away from the ego vehicle
settings.actor_active_distance = 2000

world.apply_settings(settings)
</code></pre>
<p>In the TM, dormant actors can be configured to continually respawn around the hero vehicle instead of remaining dormant on other parts of the map. This option can be configured using the <code>set_respawn_dormant_vehicles</code> method in the Python API. Vehicles will be respawned within a user-definable distance of the hero vehicle. The upper and lower boundaries of the respawnable distance can be set using the <code>set_boundaries_respawn_dormant_vehicles</code> method. Note that the upper distance will not be bigger than the tile streaming distance of the large map and the minimum lower distance is 20m.</p>
<p>To enable respawning of dormant vehicles within 25 and 700 meters of the hero vehicle:</p>
<pre><code class="language-py">my_tm.set_respawn_dormant_vehicles(True)
my_tm.set_boundaries_respawn_dormant_vehicles(25,700)
</code></pre>
<p>If collisions prevent a dormant actor from being respawned, the TM will retry on the next simulation step.</p>
<p>If dormant vehicles are not respawned, their behavior will depend on whether hybrid mode is enabled. If hybrid mode has been enabled, then the dormant actors will be teleported around the map. If hybrid mode is not enabled, then dormant actor's physics will not be computed and they will stay in place until they are no longer dormant.</p>
<hr />
<p>If you have any questions about the TM, then you can ask in the <a href="https://github.com/carla-simulator/carla/discussions">forum</a>.</p>
<div class="build-buttons">
<p>
<a href="https://github.com/carla-simulator/carla/discussions" target="_blank" class="btn btn-neutral" title="Go to the CARLA forum">
CARLA forum</a>
</p>
</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../ts_traffic_simulation_overview/" class="btn btn-neutral float-left" title="交通模拟概述"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../adv_sumo/" class="btn btn-neutral float-right" title="SUMO 联合仿真">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../ts_traffic_simulation_overview/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../adv_sumo/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../extra.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
